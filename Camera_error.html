<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera-Based Blink Error Calculator</title>
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            text-align: center; 
            background-color: #f4f4f9;
            padding: 20px;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
        }
        h1 {
            color: #1a73e8;
            margin-bottom: 20px;
        }
        /* --- Camera/Video Styles --- */
        #videoContainer {
            margin: 20px auto;
            border: 2px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: inline-block;
            background-color: #fff;
        }
        video { display: none; }
        canvas { display: block; max-width: 100%; }

        /* --- Input/Result Styles --- */
        .input-group, .result-output {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: left;
        }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            background-color: #1a73e8; 
            color: white; 
            transition: background-color 0.3s ease;
        }
        button:hover { opacity: 0.9; }

        #cameraTimeDisplay, #calculatedTimeDisplay {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        #errorDisplay {
            font-size: 1.8em;
            color: #cc0000;
            background-color: #ffe6e6;
            padding: 10px;
            border-radius: 6px;
        }
        #status { color: #666; margin-bottom: 20px; }
    </style>
    
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
</head>
<body>
    <div class="container">
        <h1>ðŸ”´ Camera Blink Error Calculator</h1>
        
        <div class="input-group">
            <p><strong>Formula Constants:</strong></p>
            <label for="constant">Constant Value (C):</label>
            <input type="number" id="constant" value="0.0001" step="any" placeholder="Enter Constant Value (e.g., 0.0001)">

            <label for="amps">Current (Amps):</label>
            <input type="number" id="amps" value="10.0" step="any" placeholder="Enter Current in Amps (e.g., 10.0)">
        </div>
        
        <p id="status">Waiting for OpenCV.js and camera access...</p>
        <div id="videoContainer">
            <video id="cameraFeed" autoplay muted playsinline></video>
            <canvas id="videoCanvas"></canvas>
        </div>

        <div class="result-output">
            <p><strong>Results:</strong></p>
            <div id="cameraTimeDisplay">Camera Time (Actual): -- seconds</div>
            <div id="calculatedTimeDisplay">Theoretical Time (Formula): -- seconds</div>
            <button onclick="calculateError()">CALCULATE ERROR</button>
            <div id="errorDisplay">Error Percentage: --%</div>
        </div>
    </div>

    <script>
        // --- Configuration Constants ---
        const REAR_CAMERA_FACING_MODE = 'environment'; 
        const BLINK_THRESHOLD = 120; // Adjust this if detection is poor

        // --- Global Variables ---
        let video, canvas, context, src;
        let lastState = 0; 
        let lastBlinkTime = 0;
        let isProcessing = false;
        let cameraTimeSeconds = 0; // NEW: Stores the time measured by the camera

        // --- OpenCV/Camera Functions (from the first code) ---

        function onOpenCvReady() {
            document.getElementById('status').innerText = 'OpenCV Ready. Requesting rear camera...';
            video = document.getElementById('cameraFeed');
            canvas = document.getElementById('videoCanvas');
            context = canvas.getContext('2d', { willReadFrequently: true });
            startCamera();
        }

        function startCamera() {
            const constraints = { video: { facingMode: REAR_CAMERA_FACING_MODE } };
            navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                        document.getElementById('status').innerText = 'Rear Camera Active. Point at the blinking light.';
                        isProcessing = true;
                        requestAnimationFrame(processFrame);
                    };
                })
                .catch((err) => {
                    document.getElementById('status').innerText = 'âŒ Rear Camera failed. Trying default camera...';
                    navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
                        video.srcObject = stream;
                        video.onloadedmetadata = () => {
                            video.play();
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                            document.getElementById('status').innerText = 'Default Camera Active (Couldn\'t find rear camera).';
                            isProcessing = true;
                            requestAnimationFrame(processFrame);
                        };
                    }).catch((e) => {
                        document.getElementById('status').innerText = 'âŒ Camera Error: ' + e.name + '. Cannot start video feed.';
                        console.error("Camera access failed:", e);
                    });
                });
        }
        
        function updateCameraDisplay(timeDiff) {
            if (timeDiff > 0) {
                cameraTimeSeconds = timeDiff; // Store the new camera time
                document.getElementById('cameraTimeDisplay').innerHTML = 
                    `Camera Time (Actual): <span style="color: darkgreen;">${timeDiff.toFixed(3)} seconds</span>`;
            } else {
                document.getElementById('cameraTimeDisplay').innerHTML = 
                    `Camera Time (Actual): <span style="color: gray;">-- seconds</span>`;
            }
        }

        function processFrame() {
            if (!isProcessing) return;

            // Frame Capture, Red Channel Isolation, and Intensity Calculation... (OpenCV part)
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            src.data.set(imageData.data);

            let channels = new cv.MatVector();
            cv.split(src, channels);
            let redChannel = channels.get(0); 
            let avgRedIntensity = cv.mean(redChannel)[0]; 
            channels.delete(); 
            
            // Blink Timing Logic
            let currentState = avgRedIntensity > BLINK_THRESHOLD ? 1 : 0;
            
            if (currentState === 1 && lastState === 0) {
                const now = performance.now(); 
                
                if (lastBlinkTime > 0) {
                    let timeDifference = (now - lastBlinkTime) / 1000;
                    document.getElementById('status').innerText = `Blink detected! Time diff: ${timeDifference.toFixed(3)}s`;
                    updateCameraDisplay(timeDifference); // Update the display and store the time
                } else {
                    document.getElementById('status').innerText = 'First blink detected. Waiting for the next one...';
                }
                
                lastBlinkTime = now;
            } 
            
            lastState = currentState;

            requestAnimationFrame(processFrame);
        }

        // --- Error Calculation Function (from the second code) ---

        function calculateError() {
            const constant = parseFloat(document.getElementById('constant').value);
            const amps = parseFloat(document.getElementById('amps').value);

            // 1. Validation
            if (isNaN(constant) || isNaN(amps) || constant === 0 || amps === 0 || cameraTimeSeconds === 0) {
                document.getElementById('errorDisplay').textContent = "ERROR: Enter non-zero constants AND ensure the camera has measured at least one blink interval.";
                document.getElementById('calculatedTimeDisplay').textContent = "Theoretical Time (Formula): -- seconds";
                return;
            }

            // 2. Theoretical Calculation (Formula: Blinks = (13800 / (Constant Ã— Amps)))
            // NOTE: The formula result is the *theoretical time* between blinks in seconds.
            const theoreticalTime = 13800 / (constant * amps); 
            const actualTime = cameraTimeSeconds; // Actual time is the camera's measurement

            // 3. Error Calculation: ((Theoretical - Actual) / Actual) * 100
            const errorPercentage = ((theoreticalTime - actualTime) / actualTime) * 100;

            // 4. Display Results
            document.getElementById('calculatedTimeDisplay').innerHTML = 
                `Theoretical Time (Formula): <span style="color: #0056b3;">${theoreticalTime.toFixed(3)} seconds</span>`;

            document.getElementById('errorDisplay').innerHTML = 
                `Error Percentage: <span style="color: ${Math.abs(errorPercentage) < 5 ? 'darkgreen' : 'red'};">${errorPercentage.toFixed(2)}%</span>`;
            
            document.getElementById('status').innerText = 'Calculation Complete.';
        }
    </script>
</body>
</html>
